#!/bin/bash
#
# Author: Florian Haftmann, TU Muenchen
#
# Building a Haskabelle distribution from repository.

## diagnostics

function fail()
{
  echo "$1" >&2
  exit 2
}

## environment

HASKABELLE_HOME="$(cd "$(dirname "$0")"; cd "$(pwd -P)"; cd ..; pwd)"

if [ -z "$HG" ]
then
  HG=hg
fi
if type -p $HG > /dev/zero
then
  HG=$(type -p $HG)
else
  fail "Mercurial not found"
fi

if [ -z $REPOSITORY ]
then
  REPOSITORY="$("$HG" showconfig paths.default)"
fi

if [ "$1" == "--regression" ]
then
  REGRESSION=1
  shift
else
  REGRESSION=
fi

if [ -z "$1" ]
then
  REVISION=tip
  VERSION=""
  ARCHIVE="haskabelle-$("$HG" tip --template '{date|shortdate}')"
else
  REVISION="$1"
  VERSION="$REVISION"
  ARCHIVE="$REVISION"
fi

DIST_HOME="${DIST_HOME:-$HOME/tmp/haskabelle-dist}"
mkdir -p "$DIST_HOME" || fail "Could not allocate directory $DIST_HOME"

## check out

cd "$DIST_HOME"
mkdir "$ARCHIVE" || fail "Directory $ARCHIVE already exists"
cd "$ARCHIVE"
"$HG" -R "$REPOSITORY" archive -t files . || fail "Could not check out source files"

## remove junk

rm AGENDA
rm .hgignore
rm .hg_archival.txt
rm doc/*
rm $(find ex/src_hs -name "*.disabled")

## brand version

if [ -n "$VERSION" ]
then
  perl -i -pe 's/"Haskabelle \(repository snapshot\)"/"'$VERSION'"/g' Importer/Version.hs
fi

## building generated files

bin/mk_adapt || fail "Could not build adaption table"
admin/builddoc || fail "Could not buld documentation"

## include manual

mv -f doc-src/Haskabelle/haskabelle.pdf doc/haskabelle.pdf
rm -rf doc-src

## regression, if desired

if [ "$REGRESSION" ]
then
  bin/regression
end

## remove admin

rm -rf admin

## dist bundle

cd ..
tar -czvf "$ARCHIVE.tar.gz" "$ARCHIVE" || fail "Could not build archive"
echo DIST_HOME="$DIST_HOME"
echo ARCHIVE="$ARCHIVE"
