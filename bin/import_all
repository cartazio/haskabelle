#!/bin/bash
#
# $Id$
# Author: Florian Haftmann, TU Muenchen
#
# Roundtrip for all Haskell files in the examples directory.

function fail()
{
  echo "$1" >&2
  #exit 2
}

EXECPATH="$(dirname "$0")/.."

[ -z "$EXECPATH" ] && fail "$0 must be called with explicit path"

[ -z "$ISABELLE_HOME" ] && ISABELLE_HOME="$(isatool getenv -b ISABELLE_HOME)"
ISATOOL="$ISABELLE_HOME/bin/isatool"

cd "$EXECPATH"
for SRC in ex/src_hs/*.hs
do
  DST=ex/dst_thy/
  ./bin/import_file "$SRC" "$DST" || fail "could not import $SRC"
done

cp -vu adapt/Prelude.thy ex/dst_thy/
cd ex/dst_thy/
for THY in *.thy
do
  THY_NAME="$(basename $THY .thy)"
  DST="../../ex/dst_hs/"
  echo "re-importing $THY_NAME..."
  "$ISATOOL" codegen HOL "$THY_NAME" "\"$THY_NAME.*\" in Haskell module_name "$THY_NAME" file \"$DST\"" > /dev/zero || fail "could not re_import $THY"
done
