#!/bin/bash
#
# Author: Florian Haftmann, TU Muenchen
#
# Shell interface for adaption table builder.

## environment

PRG="$(basename "$0")"
HASKABELLE_HOME="$(cd "$(dirname "$0")"; cd "$(pwd -P)"; cd ..; pwd)"

## diagnostics

function fail()
{
  echo "$1" >&2
  exit 2
}

## parameters

if [ "$1" == "" ]
then
  DIR="$HASKABELLE_HOME/default"
else
  DIR="$1"
fi

## file names

CONV="$HASKABELLE_HOME/lib/mk_adapt.ML"
SRC="$DIR/adapt.txt"
DST="$DIR/Generated_Adapt.hs"
PRELUDE_NAME="Prelude"
PRELUDE="$DIR/$PRELUDE_NAME"

## convert

CMD="(use \"$CONV\"; use_thy \"$PRELUDE\") handle Toplevel.TOPLEVEL_ERROR => (writeln \"ERROR\"; OS.Process.exit OS.Process.failure); Mk_Adapt.run (Thy_Info.get_theory \"$PRELUDE_NAME\") \"$SRC\" \"$DST\";"
"$HASKABELLE_HOME/bin/isabelle-process" -r -q -e "$CMD" HOL 2> /dev/zero || fail "Building adaptation table failed." 
