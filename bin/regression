#!/bin/bash
#
# Author: Florian Haftmann, TU Muenchen
#
# Roundtrip for all Haskell files in the examples directory.

## environment

PRG="$(basename "$0")"
HASKABELLE_HOME="$(cd "$(dirname "$0")"; cd "$(pwd -P)"; cd ..; pwd)"

## diagnostics

function fail()
{
  echo "$1" >&2
  exit 2
}

## cleaning

if [ "$1" == "clean" ]
then
  cd "$HASKABELLE_HOME"
  rm -v ex/dst_thy/* ex/dst_hs/*
  exit 0
fi

## operating mode

if [ "$1" == "no_reimport" ]
then
  REIMPORT=""
else
  REIMPORT=1
  if [ "$1" == "no_abort" ]
  then
    ABORT=""
  else
    ABORT=1
  fi
fi

function fail_or_warn()
{
  if [ $ABORT ]
  then fail "$1"
  else
    echo "$1" >&2
  fi
}

## building

cd "$HASKABELLE_HOME"
bin/buildbin || fail "Could not build source"

## testing

for SRC in ex/src_hs/*.hs
do
  DST=ex/dst_thy/
  echo "importing $SRC..."
  bin/haskabelle "$SRC" "$DST" > /dev/zero 2> /dev/zero || fail "Could not import $SRC"
done

## re-importing

if [ $REIMPORT ]
then
  cd ex/dst_thy/
  DST="../../ex/dst_hs/"
  mkdir -p "$DST"
  for THY in *.thy
  do
    THY_NAME="$(basename $THY .thy)"
    echo "re-importing $THY_NAME..."
    "$HASKABELLE_HOME/bin/isabelle" codegen -q HOL "$THY_NAME" "\"$THY_NAME._\" in Haskell module_name "$THY_NAME" file \"$DST\"" > /dev/zero 2> /dev/zero || fail_or_warn "Could not re-import $THY"
    HS_FILE="$DST$THY_NAME.hs"
    if [ ! -e "$HS_FILE" ]
    then
      fail "Something went wrong generating $HS_FILE"
    fi
  done
fi

