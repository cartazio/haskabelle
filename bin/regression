#!/bin/bash
#
# Author: Florian Haftmann, TU Muenchen
#
# Roundtrip for all Haskell files in the examples directory.

## environment

PRG="$(basename "$0")"
HASKABELLE_HOME="$(cd "$(dirname "$0")"; cd "$(pwd -P)"; cd ..; pwd)"

## diagnostics

function fail()
{
  echo "$1" >&2
  exit 2
}

## cleaning

if [ "$1" == "clean" ]
then
  cd "$HASKABELLE_HOME"
  rm -v ex/dst_thy/* ex/dst_hs/*
  exit 0
fi

## building

cd "$HASKABELLE_HOME"
bin/buildbin || fail "Could not build source"

## testing

for SRC in ex/src_hs/*.hs
do
  DST=ex/dst_thy/
  echo "importing $SRC..."
  bin/haskabelle "$SRC" "$DST" > /dev/zero 2> /dev/zero || fail "Could not import $SRC"
done

## re-importing

if [ "$1" != "no_reimport" ]
then
  cp -vu misc/Prelude.thy ex/dst_thy/
  cd ex/dst_thy/
  for THY in *.thy
  do
    THY_NAME="$(basename $THY .thy)"
    DST="../../ex/dst_hs/"
    echo "re-importing $THY_NAME..."
    "$HASKABELLE_HOME/bin/isabelle" codegen HOL "$THY_NAME" "\"$THY_NAME.*\" in Haskell module_name "$THY_NAME" file \"$DST\"" > /dev/zero 2> /dev/zero || fail "Could not re-import $THY"
  done
fi

